<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¬´í•œ ìŠ¤í¬ë¡¤ ì‹¤ìŠµ</title>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; margin: 0; padding: 0; background-color: #f9f9f9; }
        header { background-color: #333; color: white; padding: 1rem; text-align: center; position: fixed; top: 0; width: 100%; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .content-area { max-width: 800px; margin: 100px auto 20px; padding: 20px; min-height: 100vh; }
        
        .product-item {
            background: white; border: 1px solid #ddd; border-radius: 8px;
            margin-bottom: 20px; padding: 20px; display: flex; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.2s;
            opacity: 0; animation: fadeIn 0.5s forwards;
        }
        @keyframes fadeIn { to { opacity: 1; } }
        .product-item:hover { transform: translateY(-3px); }
        .circle { width: 50px; height: 50px; background-color: #3498db; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 20px; flex-shrink: 0; }
        .info h3 { margin: 0 0 5px 0; color: #333; }
        .info p { margin: 0; color: #666; font-size: 0.9em; }
        .price { margin-left: auto; font-weight: bold; color: #e74c3c; font-size: 1.2em; }
        
        /* ë°”ë‹¥ ê°ì§€ ì„¼ì„œ (Sentinel) */
        #sentinel { height: 20px; margin-top: 20px; border: 1px dashed transparent; }
        
        #loader { text-align: center; padding: 20px; display: none; color: #666; }
        .end-msg { text-align: center; color: #888; padding: 30px; font-weight: bold; display: none; }
    </style>
</head>
<body>
    <header>
        <h1>ë¬´í•œ ìŠ¤í¬ë¡¤ ë°ì´í„° ìˆ˜ì§‘ (Page <span id="page-num">0</span>)</h1>
    </header>

    <div class="content-area" id="container">
        <!-- ì•„ì´í…œ ì¶”ê°€ ì˜ì—­ -->
    </div>

    <div id="loader">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘... â³</div>
    <!-- âœ… ìŠ¤í¬ë¡¤ ê°ì§€ìš© ì„¼ì„œ -->
    <div id="sentinel"></div>
    <div id="end-message" class="end-msg">ëª¨ë“  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤! ğŸ‰</div>

    <script>
        let page = 1;
        let isLoading = false;
        let isFinished = false;
        const container = document.getElementById('container');
        const loader = document.getElementById('loader');
        const sentinel = document.getElementById('sentinel');
        const endMsg = document.getElementById('end-message');
        const pageNumDisplay = document.getElementById('page-num');
        const ITEMS_PER_PAGE = 20; // 20ê°œë¡œ ì¦ê°€

        async function loadItems() {
            if (isLoading || isFinished) return;
            
            isLoading = true;
            loader.style.display = 'block';

            try {
                let items = [];
                const isPreview = window.location.protocol === 'blob:' || window.location.protocol === 'file:';

                if (isPreview) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                    if (page > 10) items = [];
                    else {
                        const startId = (page - 1) * ITEMS_PER_PAGE + 1;
                        items = Array.from({length: ITEMS_PER_PAGE}, (_, i) => ({
                            id: startId + i,
                            title: `[Preview] ìƒí’ˆ ${startId + i}`,
                            price: (startId + i) * 1000,
                            description: "ë¯¸ë¦¬ë³´ê¸° í™˜ê²½ ê°€ì§œ ë°ì´í„°ì…ë‹ˆë‹¤."
                        }));
                    }
                } else {
                    const response = await fetch(`/api/items?page=${page}`);
                    items = await response.json();
                }

                if (items.length === 0) {
                    isFinished = true;
                    loader.style.display = 'none';
                    sentinel.style.display = 'none';
                    endMsg.style.display = 'block';
                    return;
                }

                items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'product-item';
                    
                    const title = item.title || item.name || 'ì œëª© ì—†ìŒ';
                    const description = item.description || 'ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.';
                    const price = item.price ? item.price.toLocaleString() : '0';

                    div.innerHTML = `
                        <div class="circle">${item.id}</div>
                        <div class="info">
                            <h3>${title}</h3>
                            <p>${description}</p>
                        </div>
                        <div class="price">${price}ì›</div>
                    `;
                    container.appendChild(div);
                });

                pageNumDisplay.innerText = page;
                page++;

            } catch (err) {
                console.error("Load Error:", err);
                loader.innerText = "ë¡œë”© ì‹¤íŒ¨ (ìƒˆë¡œê³ ì¹¨ í•„ìš”)";
            } finally {
                isLoading = false;
                loader.style.display = 'none';
                
                // âœ… ì¤‘ìš”: ë¡œë”©ì´ ëë‚¬ëŠ”ë°ë„ ì„¼ì„œê°€ ì—¬ì „íˆ í™”ë©´ì— ë³´ì´ë©´(í™”ë©´ì´ ë„ˆë¬´ ì»¤ì„œ) ì¦‰ì‹œ ë” ë¡œë”©í•¨
                checkSentinelVisibility();
            }
        }

        const observer = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting) {
                loadItems();
            }
        }, { threshold: 0.1 });

        observer.observe(sentinel);

        // ë¡œë”© ì™„ë£Œ í›„ ì¬ê²€ì‚¬ í•¨ìˆ˜
        function checkSentinelVisibility() {
            if (!isFinished && !isLoading) {
                const rect = sentinel.getBoundingClientRect();
                const isVisible = (
                    rect.top >= 0 &&
                    rect.left >= 0 &&
                    rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
                    rect.right <= (window.innerWidth || document.documentElement.clientWidth)
                );
                if (isVisible) {
                    console.log("í™”ë©´ì´ ë‚¨ì•„ì„œ ì¶”ê°€ ë¡œë”©í•©ë‹ˆë‹¤...");
                    loadItems();
                }
            }
        }
    </script>
</body>
</html>