<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¬´í•œ ìŠ¤í¬ë¡¤ ì‹¤ìŠµ</title>
    <!-- Tailwind CSS CDN ì¶”ê°€ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Tailwindë¡œ ëŒ€ì²´í•˜ê¸° ë³µì¡í•œ ì»¤ìŠ¤í…€ ì• ë‹ˆë©”ì´ì…˜ë§Œ ë‚¨ê¹€ */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fadeIn { animation: fadeIn 0.5s forwards; }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <header class="fixed top-0 left-0 w-full z-50 bg-gray-800 text-white p-4 text-center shadow-md">
        <h1 class="text-xl font-bold">ë¬´í•œ ìŠ¤í¬ë¡¤ ë°ì´í„° ìˆ˜ì§‘ (Page <span id="page-num">0</span>)</h1>
    </header>

    <!-- ì½˜í…ì¸  ì˜ì—­ -->
    <div id="container" class="max-w-3xl mx-auto mt-28 px-5 min-h-screen">
        <!-- ì•„ì´í…œ ì¶”ê°€ ì˜ì—­ -->
    </div>

    <!-- ë¡œë” ë° ìƒíƒœ ë©”ì‹œì§€ -->
    <div id="loader" class="text-center p-5 text-gray-500 hidden">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘... â³</div>
    
    <!-- âœ… ìŠ¤í¬ë¡¤ ê°ì§€ìš© ì„¼ì„œ -->
    <div id="sentinel" class="h-5 mt-5 border border-dashed border-transparent"></div>
    
    <div id="end-message" class="text-center text-gray-400 font-bold p-8 hidden">ëª¨ë“  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤! ğŸ‰</div>

    <script>
        let page = 1;
        let isLoading = false;
        let isFinished = false;
        const container = document.getElementById('container');
        const loader = document.getElementById('loader');
        const sentinel = document.getElementById('sentinel');
        const endMsg = document.getElementById('end-message');
        const pageNumDisplay = document.getElementById('page-num');
        
        // í•œ í˜ì´ì§€ë‹¹ 20ê°œì”© ë¶ˆëŸ¬ì™€ì„œ ìŠ¤í¬ë¡¤ë°” ìƒì„± ìœ ë„
        const ITEMS_PER_PAGE = 20;

        async function loadItems() {
            if (isLoading || isFinished) return;
            
            isLoading = true;
            // Tailwind hidden í´ë˜ìŠ¤ í† ê¸€ ë°©ì‹ ëŒ€ì‹  style.display ì‚¬ìš© (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
            loader.style.display = 'block';

            try {
                let items = [];
                const isPreview = window.location.protocol === 'blob:' || window.location.protocol === 'file:';

                if (isPreview) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                    if (page > 10) items = [];
                    else {
                        const startId = (page - 1) * ITEMS_PER_PAGE + 1;
                        items = Array.from({length: ITEMS_PER_PAGE}, (_, i) => ({
                            id: startId + i,
                            title: `[Preview] ìƒí’ˆ ${startId + i}`,
                            price: (startId + i) * 1000,
                            description: "ë¯¸ë¦¬ë³´ê¸° í™˜ê²½ ê°€ì§œ ë°ì´í„°ì…ë‹ˆë‹¤."
                        }));
                    }
                } else {
                    const response = await fetch(`/api/items?page=${page}`);
                    items = await response.json();
                }

                if (items.length === 0) {
                    isFinished = true;
                    loader.style.display = 'none';
                    sentinel.style.display = 'none';
                    endMsg.style.display = 'block';
                    return;
                }

                items.forEach(item => {
                    const div = document.createElement('div');
                    
                    // âœ… Tailwind í´ë˜ìŠ¤ ì ìš©
                    // Selenium ì‹¤ìŠµìš© 'product-item' í´ë˜ìŠ¤ëŠ” ë§¨ ì•ì— ìœ ì§€
                    div.className = 'product-item bg-white border border-gray-200 rounded-lg mb-5 p-5 flex items-center shadow-sm transition-transform duration-200 hover:-translate-y-1 opacity-0 animate-fadeIn';
                    
                    const title = item.title || item.name || 'ì œëª© ì—†ìŒ';
                    const description = item.description || 'ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.';
                    const price = item.price ? item.price.toLocaleString() : '0';

                    div.innerHTML = `
                        <div class="circle w-12 h-12 bg-blue-500 rounded-full text-white flex items-center justify-center font-bold mr-5 shrink-0 shadow-sm">${item.id}</div>
                        <div class="info flex-1">
                            <h3 class="text-gray-800 font-bold mb-1 text-lg">${title}</h3>
                            <p class="text-gray-500 text-sm m-0 leading-relaxed">${description}</p>
                        </div>
                        <div class="price ml-auto font-bold text-red-500 text-xl tracking-tight">${price}ì›</div>
                    `;
                    container.appendChild(div);
                });

                pageNumDisplay.innerText = page;
                page++;

            } catch (err) {
                console.error("Load Error:", err);
                loader.innerText = "ë¡œë”© ì‹¤íŒ¨ (ìƒˆë¡œê³ ì¹¨ í•„ìš”)";
            } finally {
                isLoading = false;
                loader.style.display = 'none';
                
                checkSentinelVisibility();
            }
        }

        const observer = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting) {
                loadItems();
            }
        }, { threshold: 0.1 });

        observer.observe(sentinel);
        
        // âœ… í˜ì´ì§€ ì ‘ì† ì‹œ ì´ˆê¸° ë°ì´í„° 20ê°œë¥¼ ì¦‰ì‹œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
        loadItems();

        function checkSentinelVisibility() {
            if (!isFinished && !isLoading) {
                const rect = sentinel.getBoundingClientRect();
                const isVisible = (
                    rect.top >= 0 &&
                    rect.left >= 0 &&
                    rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
                    rect.right <= (window.innerWidth || document.documentElement.clientWidth)
                );
                if (isVisible) {
                    console.log("í™”ë©´ì´ ë‚¨ì•„ì„œ ì¶”ê°€ ë¡œë”©í•©ë‹ˆë‹¤...");
                    loadItems();
                }
            }
        }
    </script>
</body>
</html>